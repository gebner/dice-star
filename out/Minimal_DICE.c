/* 
  This file was generated by KreMLin <https://github.com/FStarLang/kremlin>
  KreMLin invocation: krml -no-prefix Minimal.DICE ./src/Minimal.DICE.fst -skip-compilation -tmpdir ./out -I ./src -I /home/zhetao/Sources/hacl-star/specs -I /home/zhetao/Sources/hacl-star/specs/lemmas -I /home/zhetao/Sources/hacl-star/code/hash -I /home/zhetao/Sources/hacl-star/code/hkdf -I /home/zhetao/Sources/hacl-star/code/hmac -I /home/zhetao/Sources/hacl-star/code/curve25519 -I /home/zhetao/Sources/hacl-star/code/ed25519 -I /home/zhetao/Sources/hacl-star/lib -I /home/zhetao/Sources/hacl-star/providers/evercrypt -warn-error +11
  F* version: 953b2211
  KreMLin version: e324b7e6
 */

#include "Minimal_DICE.h"

void
dice_on_stack(HWIface_state st, uint32_t riot_size, Lib_IntTypes_sec_int_t____ *riot_binary)
{
  Lib_IntTypes_sec_int_t____ *uds = HWIface_get_uds(st);
  Lib_IntTypes_sec_int_t____ *cdi = HWIface_get_cdi(st);
  KRML_CHECK_SIZE(sizeof (Lib_IntTypes_sec_int_t____), HWIface_digest_length);
  Lib_IntTypes_sec_int_t____ uDigest[HWIface_digest_length];
  for (uint32_t _i = 0U; _i < HWIface_digest_length; ++_i)
    uDigest[_i] = Lib_IntTypes_mk_int(Lib_IntTypes_U8, Lib_IntTypes_SEC, (krml_checked_int_t)0x00);
  Hacl_Hash_SHA2_hash_256(uds, HWIface_uds_length, uDigest);
  KRML_CHECK_SIZE(sizeof (Lib_IntTypes_sec_int_t____), HWIface_digest_length);
  Lib_IntTypes_sec_int_t____ rDigest[HWIface_digest_length];
  for (uint32_t _i = 0U; _i < HWIface_digest_length; ++_i)
    rDigest[_i] = Lib_IntTypes_mk_int(Lib_IntTypes_U8, Lib_IntTypes_SEC, (krml_checked_int_t)0x00);
  Hacl_Hash_SHA2_hash_256(riot_binary, riot_size, rDigest);
  Hacl_HMAC_compute_sha2_256(cdi,
    uDigest,
    HWIface_digest_length,
    rDigest,
    HWIface_digest_length);
}

HWIface_state dice_main(uint32_t riot_size, Lib_IntTypes_sec_int_t____ *riot_binary)
{
  HWIface_state st = HWIface_initialize(riot_binary);
  dice_on_stack(st, riot_size, riot_binary);
  HWIface_unset_uds(st);
  HWIface_disable_uds(st);
  return st;
}

exit_code main()
{
  kremlinit_globals();
  if
  (
    Prims_op_LessThan((krml_checked_int_t)0,
      FStar_UInt32_v(riot_size))
    &&
      Prims_op_LessThanOrEqual(FStar_UInt32_v(riot_size),
        Prims_op_Subtraction(Prims_pow2((krml_checked_int_t)61), (krml_checked_int_t)1))
  )
  {
    HWIface_state st = dice_main(riot_size, riot_binary);
    return EXIT_SUCCESS;
  }
  else
    return EXIT_FAILURE;
}

