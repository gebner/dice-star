/* 
  This file was generated by KreMLin <https://github.com/FStarLang/kremlin>
  KreMLin invocation: krml ./src/Minimal.DICE.fst -no-prefix Hacl.Frodo.Random -bundle Hacl.Spec.*,Spec.*[rename=Hacl_Spec] -bundle Lib.*[rename=Hacl_Lib] -drop Lib.IntVector.Intrinsics -fparentheses -fno-shadow -fcurly-braces -bundle LowStar.* -bundle Prims,C.Failure,C,C.String,C.Loops,Spec.Loops,C.Endianness,FStar.*[rename=Hacl_Kremlib] -bundle Meta.* -minimal -add-include "kremlin/internal/types.h" -add-include "kremlin/lowstar_endianness.h" -add-include <string.h> -drop WasmSupport -tmpdir ./out -I ./src -add-include "kremlin/internal/compat.h" -I /home/zhetao/Sources/kremlin/include -I /home/zhetao/Sources/kremlin/kremlib/dist/generic -I /home/zhetao/Sources/hacl-star/specs -I /home/zhetao/Sources/hacl-star/specs/lemmas -I /home/zhetao/Sources/hacl-star/code/hash -I /home/zhetao/Sources/hacl-star/code/hkdf -I /home/zhetao/Sources/hacl-star/code/hmac -I /home/zhetao/Sources/hacl-star/code/curve25519 -I /home/zhetao/Sources/hacl-star/code/ed25519 -I /home/zhetao/Sources/hacl-star/lib -I /home/zhetao/Sources/hacl-star/providers/evercrypt -I /home/zhetao/Sources/kremlin/kremlib -o ./out/dice.exe
  F* version: 9c3c5d28
  KreMLin version: fe104c22
 */

#include "Minimal_DICE.h"

void Minimal_DICE_dice_main(Minimal_Hardware_state st)
{
  Lib_IntTypes_sec_int_t____ *uds = Minimal_Hardware_get_uds(st);
  Lib_IntTypes_sec_int_t____ *cdi = Minimal_Hardware_get_cdi(st);
  uint32_t riot_size = Minimal_Hardware_get_binary_size(Minimal_Hardware_get_header(st));
  Lib_IntTypes_sec_int_t____
  *riot_binary = Minimal_Hardware_get_binary(Minimal_Hardware_get_header(st));
  KRML_CHECK_SIZE(sizeof (Lib_IntTypes_sec_int_t____), (uint32_t)32U);
  Lib_IntTypes_sec_int_t____ uDigest[32U];
  for (uint32_t _i = 0U; _i < (uint32_t)32U; ++_i)
    uDigest[_i] = Lib_IntTypes_mk_int(Lib_IntTypes_U8, Lib_IntTypes_SEC, (krml_checked_int_t)0x00);
  Hacl_Hash_SHA2_hash_256(uds, Minimal_Hardware_uds_len, uDigest);
  KRML_CHECK_SIZE(sizeof (Lib_IntTypes_sec_int_t____), (uint32_t)32U);
  Lib_IntTypes_sec_int_t____ rDigest[32U];
  for (uint32_t _i = 0U; _i < (uint32_t)32U; ++_i)
    rDigest[_i] = Lib_IntTypes_mk_int(Lib_IntTypes_U8, Lib_IntTypes_SEC, (krml_checked_int_t)0x00);
  Hacl_Hash_SHA2_hash_256(riot_binary, riot_size, rDigest);
  Hacl_HMAC_compute_sha2_256(cdi, uDigest, (uint32_t)32U, rDigest, (uint32_t)32U);
}

exit_code Minimal_DICE_main()
{
  Minimal_Hardware_state st = Minimal_Hardware_initialize();
  Minimal_Hardware_header_t header = Minimal_Hardware_get_header(st);
  uint32_t riot_size = Minimal_Hardware_get_binary_size(header);
  bool verify_succeed = Minimal_Loader_verify_header(header);
  if (verify_succeed)
  {
    if (Lib_IntTypes_lt(Lib_IntTypes_U32, (void *)(uint32_t)0U, (void *)riot_size))
    {
      Minimal_DICE_dice_main(st);
      Minimal_Hardware_unset_uds(st);
      Minimal_Hardware_disable_uds(st);
    }
    else
    {
      KRML_HOST_EPRINTF("KreMLin abort at %s:%d\n%s\n",
        __FILE__,
        __LINE__,
        "RIoT size less than or equal 0");
      KRML_HOST_EXIT(255U);
    }
  }
  else
  {
    KRML_HOST_EPRINTF("KreMLin abort at %s:%d\n%s\n",
      __FILE__,
      __LINE__,
      "RIoT header verification failed");
    KRML_HOST_EXIT(255U);
  }
  return EXIT_SUCCESS;
}

